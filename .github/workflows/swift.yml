name: iOS CI/CD

on:
  push:
    branches:
      - MyChoice
  pull_request:
    branches:
      - MyChoice

jobs:
  build_and_archive:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.x'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install dependencies
      run: npm ci

    - name: Capacitor Sync iOS
      run: npx cap sync ios

    - name: Install CocoaPods dependencies
      run: pod install --repo-update
      working-directory: ./ios/App/

    - name: Build and Archive
      run: |
        xcodebuild \
          -workspace App.xcworkspace \
          -scheme App \
          -configuration Release \
          archive \
          -archivePath build/WBTour.xcarchive \
          CODE_SIGN_IDENTITY="Apple Distribution: West Bengal Tourism (WBT12345AB)" \
          PROVISIONING_PROFILE_SPECIFIER="WBTour_Provisioning_Profile" \
          DEVELOPMENT_TEAM="WBT12345AB"
      working-directory: ./ios/App/

    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath build/WBTour.xcarchive \
          -exportPath build/ipa \
          -exportOptionsPlist ExportOptions.plist
      working-directory: ./ios/App/

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: WBTour.ipa
        path: ./ios/App/build/ipa/WBTour.ipa
